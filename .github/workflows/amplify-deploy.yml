name: CI - MMP Amplify deployment

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the main branch
  # will not run the action on specified files, so when updating readmes...
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build:
    # set the runner - os that will be used to run the commands, check github actions for more OSes
    #runs-on: macos-latest
    runs-on: ubuntu-latest
    
    # set the working directory - we dont have project in git root dir but inside KotlinMMP
    env:
      working-directory: ./KotlinMMP
      
    steps:
    # USES - uses alredy pre-defined github actions so they can be reused across other repos
    # checkout our branch into the runner (OS)  or @v2 or @master
    - uses: actions/checkout@v2
    - name: Setup Java JDK
      uses: actions/setup-java@v1
      
      # setup JAVA verssion - check github what other version are available
      with:
       java-version: '11'
    
    # configure amplify and target environment that will be used for deployment
#     - name: configure amplify
#       uses: ambientlight/amplify-cli-action@0.3.0
#       with:
#         amplify_command: configure
#         amplify_env: dev
#         amplify_cli_version: '5.5.0'
#         project_dir: ./KotlinMMP
#       env:
#         AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
#         AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#         AWS_REGION: eu-west-2

    - name: deploy test environment
      uses: ambientlight/amplify-cli-action@0.3.0
      with:
        amplify_command: add_env
        amplify_env: gitci
        amplify_cli_version: '5.5.0'
        project_dir: ./KotlinMMP
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION:  eu-west-2


    - name: Build
      run: ./gradlew build
      working-directory: ${{env.working-directory}}
      
    - name: Build the project
      run: ./gradlew assemble
      working-directory: ${{env.working-directory}}
      
      
    - name: undeploy test environment
      uses: ambientlight/amplify-cli-action@0.3.0
      # run even if previous step fails
      if: failure() || success()
      with:
        amplify_command: delete_env
        amplify_env: gitci
        amplify_cli_version: '5.5.0'
        project_dir: ./KotlinMMP
        delete_lock: false
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION:  eu-west-2
      
      # deploy app to the amplify
#     - name: deploy to amplify 
#       uses: ambientlight/amplify-cli-action@0.3.0
#       with:
#         amplify_command: publish
#         amplify_env: dev
#         project_dir: ./KotlinMMP
#       env:
#         AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
#         AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#         AWS_REGION: eu-west-2
